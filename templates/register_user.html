<!DOCTYPE html>
<html>
<head>
    <title>Panel de Solicitudes</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <script>
        function toggleFields() {
            const massiveChangesCheckbox = document.getElementById('id_massive_changes');
            const singlePartField = document.getElementById('single-part');
            const multiplePartsFieldset = document.getElementById('multiple-parts-fieldset');

            if (massiveChangesCheckbox.checked) {
                singlePartField.style.display = 'none';
                multiplePartsFieldset.style.display = 'block';
            } else {
                singlePartField.style.display = 'block';
                multiplePartsFieldset.style.display = 'none';
            }
        }

        function addForm(formsetPrefix) {
            const totalForms = document.getElementById(`id_${formsetPrefix}-TOTAL_FORMS`);
            const currentFormCount = parseInt(totalForms.value);
            const formContainer = document.getElementById('form-container');
            const newForm = document.createElement('div');
            newForm.innerHTML = formContainer.firstElementChild.innerHTML.replace(/form-\d+/g, `form-${currentFormCount}`);
            newForm.querySelectorAll('input').forEach(input => input.value = '');
            formContainer.appendChild(newForm);
            totalForms.value = currentFormCount + 1;
        }

        $(document).ready(function () {
            $('#id_massive_changes').prop('checked', false);
            toggleFields();

            $('#id_massive_changes').change(function () {
                toggleFields();
            });

            $('#create-solicitud-form').submit(function (e) {
                e.preventDefault();

                $.ajax({
                    type: 'POST',
                    url: '{% url "releases:create_solicitud" %}',
                    data: $(this).serialize(),
                    success: function (response) {
                        $('#createSolicitudModal').modal('hide');
                        location.reload();
                    },
                    error: function (response) {
                        console.log('Error:', response);
                    }
                });
            });

            $('#add-more-btn').click(function () {
                addForm('form');
            });
        });
    </script>
</head>
<body>
    <h1>Panel de Solicitudes</h1>
    {% if user.is_authenticated %}
        {% if request.user.profile.level == 1 %}
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createSolicitudModal">Crear Solicitud</button>
            <a href="{% url 'releases:register_user' %}">
                <button class="btn btn-secondary">Registrar Usuario</button>
            </a>
        {% elif request.user.profile.level == 0 %}
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createSolicitudModal">Crear Solicitud</button>
        {% endif %}
        <a href="{% url 'releases:logout' %}" class="btn btn-danger">Cerrar Sesión</a>
    {% else %}
        <form method="post" action="">
            {% csrf_token %}
            {{ login_form.as_p }}
            <button type="submit" name="login" class="btn btn-primary">Iniciar Sesión</button>
        </form>
    {% endif %}
    <hr>
    {% for solicitud in solicitudes %}
        <p>{{ solicitud.default_code }} - {% if solicitud.massive_changes %}Cambio Masivo{% else %}Cambio Directo{% endif %}</p>
        <a href="{% url 'releases:detail_solicitud' solicitud.id %}" class="btn btn-info">Ver Detalles</a>
        {% if user.is_authenticated and request.user.profile.level == 1 %}
            <a href="{% url 'releases:edit_solicitud' solicitud.id %}" class="btn btn-warning">Editar</a>
        {% endif %}
    {% endfor %}

    <!-- Modal -->
    <div class="modal fade" id="createSolicitudModal" tabindex="-1" aria-labelledby="createSolicitudModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createSolicitudModalLabel">Crear Solicitud</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="create-solicitud-form" method="post">
                        {% csrf_token %}
                        {{ release_form.as_p }}

                        <div id="single-part">
                            <label>Número de Parte a Cambiar</label>
                            {{ delete_part_form.as_p }}
                        </div>

                        <fieldset id="multiple-parts-fieldset" style="display: none;">
                            <legend>Números de Parte a Excluir</legend>
                            {{ delete_part_formset.management_form }}
                            <div id="form-container">
                                {% for form in delete_part_formset %}
                                    <div class="form-row">
                                        {{ form.as_p }}
                                    </div>
                                {% endfor %}
                            </div>
                            <button type="button" id="add-more-btn" class="btn btn-secondary">Agregar más</button>
                        </fieldset>

                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Enviar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
