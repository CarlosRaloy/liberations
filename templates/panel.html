<!DOCTYPE html>
<html>
<head>
    <title>Panel de Solicitudes</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <script>
        function toggleFields() {
            const massiveChangesCheckbox = document.getElementById('id_massive_changes');
            const singlePartField = document.getElementById('single-part');
            const multiplePartsFieldset = document.getElementById('multiple-parts-fieldset');

            if (massiveChangesCheckbox.checked) {
                singlePartField.style.display = 'none';
                multiplePartsFieldset.style.display = 'block';
            } else {
                singlePartField.style.display = 'block';
                multiplePartsFieldset.style.display = 'none';
            }
        }

        function addForm() {
            const formContainer = document.getElementById('form-container');
            const newForm = document.createElement('div');
            newForm.classList.add('form-row');
            newForm.innerHTML = `
                <label for="part">Part:</label>
                <input type="text" name="parts[]" class="form-control">
            `;
            formContainer.appendChild(newForm);
        }

        $(document).ready(function () {
            $('#id_massive_changes').prop('checked', false);
            toggleFields();

            $('#id_massive_changes').change(function () {
                toggleFields();
            });

            $('#create-solicitud-form').submit(function (e) {
                e.preventDefault();

                let parts = [];
                $('input[name="parts[]"]').each(function() {
                    parts.push($(this).val());
                });

                const data = {
                    default_code: $('#id_default_code').val(),
                    massive_changes: $('#id_massive_changes').is(':checked'),
                    parts: parts,
                    csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val(),
                };

                $.ajax({
                    type: 'POST',
                    url: '{% url "releases:create_solicitud" %}',
                    data: data,
                    success: function (response) {
                        $('#createSolicitudModal').modal('hide');
                        location.reload();
                    },
                    error: function (response) {
                        console.log('Error:', response);
                    }
                });
            });

            $('#add-more-btn').click(function () {
                addForm();
            });

            $('#register-user-form').submit(function (e) {
                e.preventDefault();

                $.ajax({
                    type: 'POST',
                    url: '{% url "releases:register_user" %}',
                    data: $(this).serialize(),
                    success: function (response) {
                        $('#registerUserModal').modal('hide');
                        location.reload();
                    },
                    error: function (response) {
                        console.log('Error:', response);
                    }
                });
            });
        });
    </script>
</head>
<body>
    <h1>Panel de Solicitudes</h1>
    {% if user.is_authenticated %}
        {% if request.user.profile.level == 1 %}
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createSolicitudModal">Crear Solicitud</button>
            <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#registerUserModal">Registrar Usuario</button>
        {% elif request.user.profile.level == 0 %}
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createSolicitudModal">Crear Solicitud</button>
        {% endif %}
        <a href="{% url 'releases:logout' %}" class="btn btn-danger">Cerrar Sesión</a>
    {% else %}
        <form method="post" action="">
            {% csrf_token %}
            {{ login_form.as_p }}
            <button type="submit" name="login" class="btn btn-primary">Iniciar Sesión</button>
        </form>
    {% endif %}
    <hr>
    {% for solicitud in solicitudes %}
        <p>{{ solicitud.default_code }} - {% if solicitud.massive_changes %}Cambio Masivo{% else %}Cambio Directo{% endif %}</p>
        <a href="{% url 'releases:detail_solicitud' solicitud.id %}" class="btn btn-info">Ver Detalles</a>
        {% if user.is_authenticated and request.user.profile.level == 1 %}
            <a href="{% url 'releases:edit_solicitud' solicitud.id %}" class="btn btn-warning">Editar</a>
        {% endif %}
    {% endfor %}

    <!-- Modal para crear solicitud -->
    <div class="modal fade" id="createSolicitudModal" tabindex="-1" aria-labelledby="createSolicitudModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createSolicitudModalLabel">Crear Solicitud</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="create-solicitud-form" method="post">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="id_default_code" class="form-label">Default code:</label>
                            <input type="text" id="id_default_code" name="default_code" class="form-control">
                        </div>

                        <div class="mb-3">
                            <input type="checkbox" id="id_massive_changes" name="massive_changes">
                            <label for="id_massive_changes" class="form-label">Massive changes:</label>
                        </div>

                        <div id="single-part">
                            <label for="part">Número de Parte a Cambiar</label>
                            <input type="text" name="parts[]" class="form-control">
                        </div>

                        <fieldset id="multiple-parts-fieldset" style="display: none;">
                            <legend>Números de Parte a Excluir</legend>
                            <div id="form-container">
                                <div class="form-row">
                                    <input type="text" name="parts[]" class="form-control">
                                </div>
                            </div>
                            <button type="button" id="add-more-btn" class="btn btn-secondary">Agregar más</button>
                        </fieldset>

                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Enviar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para registrar usuario -->
    <div class="modal fade" id="registerUserModal" tabindex="-1" aria-labelledby="registerUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registerUserModalLabel">Registrar Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="register-user-form" method="post">
                        {% csrf_token %}
                        {{ user_registration_form.as_p }}
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-primary">Registrar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
